/*建库建表*/
/*创建数据库*/
create database if not exists zgtpf;

/*创建用户表，保存用户的账号密码*/
create table user
(
    id        int auto_increment comment '主键ID'
        primary key,
    user_id   char(10)      not null comment '账号',
    password  varchar(16)   not null comment '密码',
    phone     char(11)      null comment '手机号',
    status    int default 1 null comment '账号状态：0为账号不可用；1为账号可用',
    user_role int           null comment '用户身份：0为管理员；1为老师；2为学生',
    constraint id
        unique (id),
    constraint user_id
        unique (user_id),
    check (length(`user_id`) = 10),
    check (length(`phone`) = 11)
)
    comment '用户表';

/*创建专业表*/
create table subject
(
    id      int auto_increment comment '主键ID'
        primary key,
    college varchar(50) null comment '学院',
    name    varchar(50) not null comment '专业名称',
    constraint id
        unique (id)
)
    comment '专业表';

/*创建课程表*/
create table course
(
    id   int auto_increment comment '主键ID'
        primary key,
    name varchar(50) not null comment '课程名称',
    constraint id
        unique (id)
)
    comment '课程表';

/*创建班级表*/
create table class
(
    id         int auto_increment comment '主键ID'
        primary key,
    grade      char(4)     null comment '年级',
    name       varchar(20) null comment '班级号',
    subject_id int         not null comment '专业ID',
    constraint class_name
        unique (name),
    constraint id
        unique (id),
    constraint fk_subject_class
        foreign key (subject_id) references subject (id)
            on update cascade
)
    comment '班级表';

/*创建信息表，用来查询用户信息*/
create table information
(
    id           int                                not null comment '主键ID'
        primary key,
    role         char(3)                            null comment '用户身份',
    name         varchar(20)                        not null comment '用户名',
    avatar       varchar(255)                       null comment '头像',
    sex          char                               null comment '性别',
    email        varchar(50)                        null comment '邮箱',
    address      varchar(255)                       null comment '地址',
    introduction varchar(255)                       null comment '个人简介',
    create_time  datetime default CURRENT_TIMESTAMP null comment '创建日期',
    school       varchar(50)                        null comment '学校',
    subject_id   int                                null comment '专业ID',
    class_id     int                                null comment '班级ID',
    constraint id
        unique (id),
    constraint fk_user_class
        foreign key (class_id) references class (id)
            on update cascade on delete set null,
    constraint fk_user_information
        foreign key (id) references user (id)
            on update cascade on delete cascade
)
    comment '用户信息表';

/*创建授课表，一个教师可以教授多个班级的多个课程*/
create table teach_course
(
    id         int auto_increment comment '主键ID'
        primary key,
    grade      char(4)     not null comment '开课年级',
    year       varchar(20) null comment '开课学年',
    teacher_id int         not null comment '教师ID',
    subject_id int         not null comment '专业ID',
    course_id  int         not null comment '课程ID',
    constraint id
        unique (id),
    constraint fk_course_teacher
        foreign key (course_id) references course (id)
            on update cascade,
    constraint fk_subject_teacher
        foreign key (subject_id) references subject (id)
            on update cascade,
    constraint fk_teacher_subject_course
        foreign key (teacher_id) references user (id)
            on update cascade
)
    comment '授课表';

/*创建试卷表*/
create table test_paper
(
    id          int auto_increment comment '主键ID'
        primary key,
    name        varchar(255)                       null comment '试卷名称',
    score       double   default 100               null comment '总分',
    start_time  datetime                           null comment '开始时间',
    end_time    datetime                           null comment '结束时间',
    watcher     varchar(20)                        null comment '监考人',
    status      int      default 0                 null comment '试卷状态：-1为已结束，0为待批阅，1为正在进行的',
    teach_id    int                                null comment '授课ID',
    create_time datetime default CURRENT_TIMESTAMP null comment '创建时间',
    constraint id
        unique (id),
    constraint name
        unique (name),
    constraint fk_test_course
        foreign key (teach_id) references teach_course (id)
        on update cascade on delete set null,
    check (`status` in (-(1), 0, 1))
)
    comment '试卷表';

/*创建问题表*/
create table question
(
    id          int auto_increment comment '主键ID'
        primary key,
    topic       varchar(255)                       not null comment '题目',
    type        int                                null comment '题目类型：1为主观题，2为客观题',
    answer      varchar(255)                       not null comment '答案',
    analysis    varchar(255)                       null comment '解析',
    score       double                             null comment '分数',
    create_time datetime default CURRENT_TIMESTAMP null comment '创建时间',
    sort        int                                null comment '题序',
    test_id     int                                null comment '试卷ID',
    constraint id
        unique (id),
    constraint fk_question_test
        foreign key (test_id) references test_paper (id),
    check (`type` in (1, 2))
)
    comment '试题表';

/*创建学生作答表*/
create table student_answer
(
    id          int auto_increment comment '主键ID'
        primary key,
    answer      varchar(255)  not null comment '学生作答',
    suspicious  int default 0 not null comment '作答是否存疑：0著错；1异常',
    status      int default 0 not null comment '批阅状态：0未批阅；1已批阅',
    score       double        null comment '得分',
    student_id  int           not null comment '学生ID',
    test_id     int           not null comment '试卷ID',
    question_id int           not null comment '题目ID',
    constraint id
        unique (id),
    constraint fk_question_answer
        foreign key (question_id) references question (id)
            on update cascade on delete cascade,
    constraint fk_student_answer
        foreign key (student_id) references user (id)
            on update cascade on delete cascade,
    constraint fk_test_answer
        foreign key (test_id) references test_paper (id)
            on update cascade on delete cascade,
    check (`suspicious` in (0, 1)),
    check (`status` in (0, 1))
)
    comment '学生作答表';

/*创建关键词选项表*/
create table word_options
(
    id           int auto_increment comment '主键ID'
        primary key,
    question_id  int              not null comment '题目ID',
    type         int              not null comment '题目类型：1为主观题，对应存放关键词，学生不可见；2为客观题，对应存放选项，学生可见',
    word_options varchar(255)     not null comment '关键词或选项',
    score        double default 0 not null comment '关键词得分',
    constraint id
        unique (id),
    constraint fk_question_options
        foreign key (question_id) references question (id)
            on update cascade on delete cascade,
    check (`type` in (1, 2))
)
    comment '关键词或选项表';

/*创建学生试卷成绩表*/
create table student_score
(
    id         int auto_increment comment '主键ID'
        primary key,
    score      double null comment '学生测试成绩',
    student_id int    not null comment '学生ID',
    test_id    int    not null comment '试卷ID',
    constraint id
        unique (id),
    constraint fk_score_student
        foreign key (student_id) references user (id)
            on update cascade on delete cascade,
    constraint fk_score_test
        foreign key (test_id) references test_paper (id)
            on update cascade on delete cascade
)
    comment '学生测试成绩表';